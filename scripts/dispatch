#!/usr/bin/perl -w

use strict;
use warnings;

use DBI;

our $config;
require './config.pl';

my $dbh = DBI->connect($config->{dbistring}, '', '') or die "Cannot connect to database!";

while(1) {
	$dbh->begin_work;
	print("==> Checking for new work...\n");
	my $next = $dbh->prepare("UPDATE talks SET state = state_next(state) WHERE id = ?");

	my $st;
	my $statelist = "'" . join("','", keys($config->{state})) . "'";
	if($config->{query_limit} > 0) {
		$st = $dbh->prepare("SELECT id, state, title FROM talks WHERE state IN ($statelist) LIMIT ? FOR UPDATE");
		$st->execute($config->{query_limit});
	} else {
		$st = $dbh->prepare("SELECT id, state, title FROM talks WHERE state IN ($statelist) FOR UPDATE");
		$st->execute;
	}
	while(my $row = $st->fetchrow_hashref) {
		if(exists($config->{state}{$row->{state}})) {
			print("Starting job for event " . $row->{title} . " in state " . $row->{state} . "...\n");
			$next->execute($row->{id});
			my $statetranssub = $config->{state}{$row->{state}};
			system &$statetranssub($row->{id});
		}
	}
	print("finished, waiting 30 seconds...\n");
	$dbh->commit;

	sleep 30;
}
